#! /bin/bash
# Configures build environment for appropriate target architecture

# Definitions
SOURCE_DIR=$(dirname $0)
WAV_RTOS_DIR=${WAV_RTOS_DIR:-${SOURCE_DIR}/rtos}
CONFIG_CAL_PLL="true"
CONFIG_CAL_ZQCAL="true"
CONFIG_CAL_SA="true"
CONFIG_DRAM_TRAIN="true"
CONFIG_CAL_PERIODIC="true"
CONFIG_TARGET_PHY="wddr100"

init_lpddr() {
  # Invoke RTOS configure script with addtional parameters
  args=(
        -DCONFIG_TARGET_PHY=${CONFIG_TARGET_PHY}
        -DCONFIG_CALIBRATE_PLL=${CONFIG_CAL_PLL}
        -DCONFIG_CALIBRATE_ZQCAL=${CONFIG_CAL_ZQCAL}
        -DCONFIG_CALIBRATE_SA=${CONFIG_CAL_SA}
        -DCONFIG_DRAM_TRAIN=${CONFIG_DRAM_TRAIN}
        -DCONFIG_CAL_PERIODIC=${CONFIG_CAL_PERIODIC}
    )
    source ${WAV_RTOS_DIR}/configure ${PARAMS} ${args[@]}
}

print_help() {
echo "Usage: configure [OPTIONS]\n"
echo "This program configures CMAKE for wavious lpddr project\n"
echo "Options:"
echo "-t, --build_type  <Debug | Release>"
echo "--target-phy      <wddr100>"
echo "--no-pll-cal      (disables PLL calibration)"
echo "--no-zqcal-cal    (disables ZQCAL calibration)"
echo "--no-sa-cal       (disables SA calibration)"
echo "--dram-train      (enables DRAM training at boot)"
echo "--periodic-cal    (enables periodic calibration)"
}

PARAMS=""
while [ $# -gt 0 ]; do
  case "$1" in
    --target-phy)
      CONFIG_TARGET_PHY=$2
      shift 2
      ;;
    --no-pll-cal)
      CONFIG_CAL_PLL="false"
      shift 1
      ;;
    --no-zqcal-cal)
      CONFIG_CAL_ZQCAL="false"
      shift 1
      ;;
     --no-sa-cal)
      CONFIG_CAL_SA="false"
      shift 1
      ;;
     --no-dram-train)
      CONFIG_DRAM_TRAIN="false"
      ;;
     --no-periodic-cal)
      CONFIG_CAL_PERIODIC="false"
      shift 1
      ;;
    -h | --help)
      print_help
      exit
      ;;
    --) # end argument parsing
      shift
      break
      ;;
    *) # preserve positional arguments
      PARAMS="$PARAMS $1"
      shift
      ;;
  esac
done
# set positional arguments in their proper place
eval set -- "$PARAMS"

init_lpddr
